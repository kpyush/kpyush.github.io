<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Serial API Example</title>
</head>
<body>
    <label for="baudRateInput">Baud Rate:</label>
    <input type="number" id="baudRateInput" value="9600">
    <button id="connectButton">Connect</button>
    <button id="sendButton" disabled>Send "a"</button>
    <div id="serialOutput"></div>

    <script>
        let port;

        async function init() {
            const baudRateInput = document.getElementById('baudRateInput').value;
            const portConfig = { baudRate: parseInt(baudRateInput, 10) };

            try {
                port = await navigator.serial.requestPort(portConfig);
                await port.open(portConfig);

                document.getElementById('connectButton').disabled = true;
                document.getElementById('sendButton').disabled = false;

                document.getElementById('sendButton').addEventListener('click', () => {
                    sendCharacter('a');
                });

                readData();
            } catch (error) {
                console.error('Error connecting to serial port:', error);
            }
        }

        async function sendCharacter(char) {
            const writer = port.writable.getWriter();
            await writer.write(new TextEncoder().encode(char));
            writer.releaseLock();
        }

        async function readData() {
            const reader = port.readable.getReader();

            while (true) {
                const { value, done } = await reader.read();

                if (done) {
                    reader.releaseLock();
                    break;
                }

                const receivedChar = new TextDecoder().decode(value);
                document.getElementById('serialOutput').textContent += receivedChar;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectButton').addEventListener('click', init);
            navigator.serial.addEventListener('disconnect', () => location.reload());
        });
    </script>
</body>
</html>
